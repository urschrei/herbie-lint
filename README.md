# herbie-lint

A Dylint lint that detects numerically unstable floating-point expressions and suggests more stable alternatives.

## Overview

This lint analyses Rust code for `f64` expressions that may suffer from numerical instability (rounding errors, precision loss, etc.) and suggests mathematically equivalent but more stable alternatives. The suggestions come from a pre-computed database of transformations generated by the [Herbie](https://herbie.uwplse.org/) tool.

The database is embedded in the lint binary, so no additional configuration is required.

## Examples

| Original Expression | Suggested Replacement | Reason |
|---------------------|----------------------|--------|
| `(a*a + b*b).sqrt()` | `a.hypot(b)` | Built-in is more stable |
| `(a + 1.0).ln()` | `a.ln_1p()` | Avoids precision loss near zero |
| `a.exp() - 1.0` | `a.exp_m1()` | Avoids precision loss near zero |

## Installation

Requires [cargo-dylint](https://github.com/trailofbits/dylint):

```bash
cargo install cargo-dylint dylint-link
```

## Usage

### Via Git (Recommended)

Add to your project's `Cargo.toml`:

```toml
[workspace.metadata.dylint]
libraries = [
    { git = "https://github.com/yourusername/herbie-lint" }
]
```

Then run:

```bash
cargo dylint --all
```

Dylint will automatically clone, build, and cache the lint.

### One-off check

```bash
cargo dylint --git https://github.com/yourusername/herbie-lint
```

### Local build

If you've cloned the repository locally:

```bash
cd herbie-lint
cargo build --release
cargo dylint --lib-path target/release/libherbie_lint@nightly-2025-09-18-aarch64-apple-darwin.dylib \
    --manifest-path /path/to/your/project/Cargo.toml
```

Note: The library filename includes your toolchain version and architecture.

## Configuration (Optional)

The lint works out of the box with no configuration. If you want to customise behaviour, create a `Herbie.toml` file in your project root:

```toml
# Use a custom database instead of the embedded one (optional)
# db_path = "path/to/custom/Herbie.db"

# Whether to call the Herbie tool for unknown expressions
# - true: Require Herbie, fail if not found
# - false: Never call Herbie
use_herbie = false

# Maximum time in seconds for Herbie to process an expression
# Set to 0 for no timeout
timeout = 120
```

## Suppressing Warnings

To suppress the lint for a specific function or module:

```rust
#[allow(herbie)]
fn my_function() {
    // Lint warnings suppressed here
}
```

Or use the `#[herbie_ignore]` attribute on items.

## Supported Functions

The following mathematical functions are recognised and can be transformed:

| Function | Arity | Description |
|----------|-------|-------------|
| `abs` | 1 | Absolute value |
| `acos` | 1 | Arc cosine |
| `asin` | 1 | Arc sine |
| `atan` | 1 | Arc tangent |
| `atan2` | 2 | Two-argument arc tangent |
| `cos` | 1 | Cosine |
| `cosh` | 1 | Hyperbolic cosine |
| `exp` | 1 | Exponential |
| `exp_m1` | 1 | Exponential minus one |
| `hypot` | 2 | Hypotenuse |
| `ln` | 1 | Natural logarithm |
| `ln_1p` | 1 | Natural log of (1 + x) |
| `powf` | 2 | Power function |
| `sin` | 1 | Sine |
| `sinh` | 1 | Hyperbolic sine |
| `sqrt` | 1 | Square root |
| `tan` | 1 | Tangent |
| `tanh` | 1 | Hyperbolic tangent |

## Custom Database

The lint includes an embedded database with common transformations. To use a custom database:

1. Set `db_path` in `Herbie.toml` to point to your SQLite database
2. Enable `use_herbie = true` to automatically discover and save new transformations (requires Herbie to be installed)

The database format is compatible with the [GHC Herbie Plugin](https://github.com/mikeizbicki/HerbiePlugin).

## Development

Build the lint:

```bash
cargo build --release
```

Run tests:

```bash
cargo test
```

## Background

This is a port of [rust-herbie-lint](https://github.com/mcarton/rust-herbie-lint) from the defunct rustc plugin system to the modern [Dylint](https://github.com/trailofbits/dylint) framework. The original plugin used `#[plugin_registrar]` which was removed in Rust 1.75.

## Licence

MIT OR Apache-2.0
